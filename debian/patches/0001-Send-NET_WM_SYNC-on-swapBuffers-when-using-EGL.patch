From e3c1eaa321f89ad5696d0c6fd012546832382353 Mon Sep 17 00:00:00 2001
From: David Edmundson <davidedmundson@kde.org>
Date: Tue, 12 Dec 2017 11:45:56 +0000
Subject: [PATCH] Send NET_WM_SYNC on swapBuffers when using EGL

If a user is using EGL on X, we need to reply to sync requests in the
same way that we do in the GLX backend.
---
 .../platforms/xcb/gl_integrations/xcb_egl/qxcbeglcontext.h        | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/src/plugins/platforms/xcb/gl_integrations/xcb_egl/qxcbeglcontext.h b/src/plugins/platforms/xcb/gl_integrations/xcb_egl/qxcbeglcontext.h
index 48e774bbb2..15e874de4c 100644
--- a/src/plugins/platforms/xcb/gl_integrations/xcb_egl/qxcbeglcontext.h
+++ b/src/plugins/platforms/xcb/gl_integrations/xcb_egl/qxcbeglcontext.h
@@ -63,6 +63,14 @@ public:
     {
         Q_XCB_NOOP(m_connection);
         QEGLPlatformContext::swapBuffers(surface);
+        if (surface->surface()->surfaceClass() == QSurface::Window) {
+            QXcbWindow *platformWindow = static_cast<QXcbWindow *>(surface);
+            // OpenGL context might be bound to a non-gui thread use QueuedConnection to sync
+            // the window from the platformWindow's thread as QXcbWindow is no QObject, an
+            // event is sent to QXcbConnection. (this is faster than a metacall)
+            if (platformWindow->needsSync())
+                platformWindow->postSyncWindowRequest();
+        }
         Q_XCB_NOOP(m_connection);
     }
 
-- 
2.15.0

