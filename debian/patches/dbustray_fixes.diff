Description: dbustray: support late registering of tray icon menu
Origin: upstream,
 https://code.qt.io/cgit/qt/qtbase.git/commit/?id=7ad930987da7bb1d
 https://code.qt.io/cgit/qt/qtbase.git/commit/?id=a4fac65938fdee74
Last-Update: 2016-02-20

--- a/src/platformsupport/dbusmenu/qdbusmenuconnection.cpp
+++ b/src/platformsupport/dbusmenu/qdbusmenuconnection.cpp
@@ -80,6 +80,14 @@
 }
 
 #ifndef QT_NO_SYSTEMTRAYICON
+bool QDBusMenuConnection::registerTrayIconMenu(QDBusTrayIcon *item)
+{
+    bool success = connection().registerObject(MenuBarPath, item->menu());
+    if (!success)  // success == false is normal, because the object may be already registered
+        qCDebug(qLcMenu) << "failed to register" << item->instanceId() << MenuBarPath;
+    return success;
+}
+
 bool QDBusMenuConnection::registerTrayIcon(QDBusTrayIcon *item)
 {
     bool success = connection().registerService(item->instanceId());
@@ -95,14 +103,8 @@
         return false;
     }
 
-    if (item->menu()) {
-        success = connection().registerObject(MenuBarPath, item->menu());
-        if (!success) {
-            unregisterTrayIcon(item);
-            qWarning() << "failed to register" << item->instanceId() << MenuBarPath;
-            return false;
-        }
-    }
+    if (item->menu())
+        registerTrayIconMenu(item);
 
     QDBusMessage registerMethod = QDBusMessage::createMethodCall(
                 StatusNotifierWatcherService, StatusNotifierWatcherPath, StatusNotifierWatcherService,
--- a/src/platformsupport/dbusmenu/qdbusmenuconnection_p.h
+++ b/src/platformsupport/dbusmenu/qdbusmenuconnection_p.h
@@ -65,6 +65,7 @@
     QDBusConnection connection() const { return m_connection; }
     bool isStatusNotifierHostRegistered() const { return m_statusNotifierHostRegistered; }
 #ifndef QT_NO_SYSTEMTRAYICON
+    bool registerTrayIconMenu(QDBusTrayIcon *item);
     bool registerTrayIcon(QDBusTrayIcon *item);
     bool unregisterTrayIcon(QDBusTrayIcon *item);
 #endif // QT_NO_SYSTEMTRAYICON
--- a/src/platformsupport/dbustray/qdbustrayicon.cpp
+++ b/src/platformsupport/dbustray/qdbustrayicon.cpp
@@ -184,16 +184,13 @@
 
 QPlatformMenu *QDBusTrayIcon::createMenu() const
 {
-    qCDebug(qLcTray);
-    QDBusPlatformMenu *ret = new QDBusPlatformMenu();
-    if (!m_menu)
-        const_cast<QDBusTrayIcon *>(this)->m_menu = ret;
-    return ret;
+    return new QDBusPlatformMenu();
 }
 
 void QDBusTrayIcon::updateMenu(QPlatformMenu * menu)
 {
     qCDebug(qLcTray) << menu;
+    bool needsRegistering = !m_menu;
     if (!m_menu)
         m_menu = qobject_cast<QDBusPlatformMenu *>(menu);
     if (!m_menuAdaptor) {
@@ -205,6 +202,8 @@
                 m_menuAdaptor, SIGNAL(LayoutUpdated(uint,int)));
     }
     m_menu->emitUpdated();
+    if (needsRegistering)
+        dBusConnection()->registerTrayIconMenu(this);
 }
 
 void QDBusTrayIcon::showMessage(const QString &title, const QString &msg, const QIcon &icon,
